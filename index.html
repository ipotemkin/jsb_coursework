<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игра</title>
    <style>
        html {
            font-family: sans-serif;
        }

        .app {
            display: flex;
            flex-direction: column;
            gap: 12px;
            
            width: 200px;
            padding: 20px;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 12px;

            /* width: 200px; */
        }


    </style>
</head>
<body>
    <div class="app"></div>

    <script>
    </script>
    <script src="template-engine.js"></script>
    <script src="templates.js"></script>
    <script src="utils.js"></script>
    <script>
        window.application = {
            root: undefined,
            token: undefined,
            nickName: undefined,
            blocks: {},
            screens: {},
            renderScreen: function(screenName) {},
            // renderBlock: function(blockName, container) {},
            renderBlock: renderBlock,
            timers: []
        }
        
        const urlDomain = 'https://skypro-rock-scissors-paper.herokuapp.com/';

        const app = window.application.root = document.querySelector('.app');
        window.application.blocks['example-button'] = renderExampleButton;
        window.application.blocks['example-input'] = renderInput;

        function renderButton(container, name, class_name='none') {
            const button = document.createElement('button');
            button.textContent = name;
            button.classList.add(class_name);

            button.addEventListener('click', () => {
                console.log('click');
            });

            container.appendChild(button);
        }

        function renderElement(container, type='div', name='', value='', class_name='none') {
            const element = document.createElement(type);
            // button.textContent = name;
            element.classList.add(class_name);
            element.value = value;

            element.addEventListener('click', () => {
                console.log('click');
            });

            container.appendChild(element);
        }

        function renderInput(container) {
            renderElement(container, 'input', 'testing input', 'testing name');
        }


        function renderExampleButton(container) {
            renderButton(container, 'Example');
        }

        function renderExampleScreen() {
            const app = document.querySelector('.app');
            app.textContent = '';

            const title = document.createElement('h1');
            title.textContent = 'Страница-пример';

            const content = document.createElement('div');
            content.classList.add('content');
                
            window.application.renderBlock('example-input', content);
            window.application.renderBlock('example-button', content);


            app.appendChild(title);
            app.appendChild(content);
        }

        function renderBlock(element, container) {
            window.application.blocks[element](container);
        }

        console.log(window.application);

        // renderExampleScreen();

        // ----- main -------
        
        function clearScreen() {
            window.application.root.textContent = '';
            console.log(window.application.root);
        }

        function renderLoginScreen() {
            clearScreen();
            const screen = templateEngine(LoginPageTemplate());
            app.appendChild(screen);
           
            const loginFormButton = document.querySelector('.login-form__button');
            const nickName = document.querySelector('.login-form__input');
            
            loginFormButton.addEventListener('click', () => {
                console.log('click');
                
                if (!nickName.value) return;
                
                console.log(nickName.value);
                
                // const url = 'https://skypro-rock-scissors-paper.herokuapp.com/player-status?token=4b18f75d-d6b5-4f47-b986-b7bf884089ef'
                // const url = urlDomain + 'ping';
                
                const url = urlDomain + `login?login=${nickName.value}`;
                
                function onSuccess(response) {
                    console.log(response);

                    if (response.status === 'ok') {
                        window.application.token = response.token;
                        renderLobbyScreen();
                    }
                    
                    console.log(window.application.token);
                }
                
                httpRequest({url, onSuccess});
            });
            
        }

        
        function getPlayerList(token, callback) {
            const url = urlDomain + `player-list?token=${token}`;
            httpRequest({url, onSuccess: callback});
        }
        
        function onGetPlayerList(response) {
            console.log(response);
        }

        function renderLobbyScreen() {
            clearScreen();
            const screen = templateEngine(LobbyPageTemplate());
            app.appendChild(screen);
                                   
            const lobbyButton = document.querySelector('.lobby__button');
            const lobbyPlayersList = document.querySelector('.lobby__players-list');
            
            getPlayerList(window.application.token, (response) => {
                console.log(response);
                let i = 1;
                for(let player of response.list) {
                    const playerElement = document.createElement('p');
                    playerElement.textContent = player.login;
                    lobbyPlayersList.appendChild(playerElement);
                    i++;
                    if (i > 3) break;
                }
            });
            
            lobbyButton.addEventListener('click', () => {
                console.log('lobby button click');

                // if (!nickName.value) return;
                
                // console.log(nickName.value);
                
                // // const url = 'https://skypro-rock-scissors-paper.herokuapp.com/player-status?token=4b18f75d-d6b5-4f47-b986-b7bf884089ef'
                // // const url = urlDomain + 'ping';
                
                // const url = urlDomain + `login?login=${nickName.value}`;
                
                // function onSuccess(response) {
                //     console.log(response);

                //     if (response.status === 'ok') {
                //         window.application.token = response.token;
                //     }
                    
                //     console.log(window.application.token);
                // }
                
                // httpRequest({url, onSuccess});
            });
            
        }




        // ----- end of main --------

        // const screen_1 = templateEngine(LoginPageTemplate());
        // app.appendChild(screen_1);

        renderLoginScreen();

        const screen_2 = templateEngine(LobbyPageTemplate());
        app.appendChild(screen_2);

        const screen_3 = templateEngine(GamePageTemplate());
        app.appendChild(screen_3);

        const screen_4 = templateEngine(WaitingPageTemplate('Игрок 2', 'Ожидаем подключение соперника...'));
        app.appendChild(screen_4);

        const screen_5 = templateEngine(WaitingPageTemplate('Игрок 2', 'Ожидаем ход соперника...'));
        app.appendChild(screen_5);

        const screen_6 = templateEngine(FinalPageTemplate('Игрок 2', 'Вы проиграли!'));
        app.appendChild(screen_6);

        // screen_6.innerHTML = '';

        // clearScreen();
        const screen_7 = templateEngine(FinalPageTemplate('Игрок 2', 'Вы выиграли!'));
        app.appendChild(screen_7);

    </script>
</body>
</html>